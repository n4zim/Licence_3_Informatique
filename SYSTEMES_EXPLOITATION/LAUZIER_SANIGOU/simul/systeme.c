
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "cpu.h"
#include "systeme.h"


/**********************************************************
** Demarrage du systeme
***********************************************************/

static PSW systeme_init(void) {
	PSW cpu;

	printf("Booting.\n");
	/*** creation d'un programme ***/
	// make_inst(0, INST_SUB, 2, 2, -1000); /* R2 -= R2-1000 */
	// make_inst(1, INST_ADD, 1, 2, 500);   /* R1 += R2+500 */
	// make_inst(2, INST_ADD, 0, 2, 200);   /* R0 += R2+200 */
	// make_inst(3, INST_ADD, 0, 1, 100);   /* R0 += R1+100 */

	make_inst(0, INST_SUB, 1, 1, 0);
	make_inst(1, INST_SUB, 2, 2, -1000);
	make_inst(2, INST_SUB, 3, 3, -10);
	make_inst(3, INST_CMP, 1, 2, 0);
	make_inst(4, INST_IFGT,0, 0, 10); 
	make_inst(5, INST_NOP, 0, 0, 0);
	make_inst(6, INST_NOP, 0, 0, 0);
	make_inst(7, INST_NOP, 0, 0, 0);
	make_inst(8, INST_ADD, 1, 3, 0);
	make_inst(9, INST_JUMP, 0, 0, 3);
	make_inst(10, INST_HALT, 0, 0, 0);
	
	/*** valeur initiale du PSW ***/
	memset (&cpu, 0, sizeof(cpu));
	cpu.PC = 0;
	cpu.SB = 0;
	cpu.SS = 20;

	return cpu;
}


/**********************************************************
** Simulation du systeme (mode systeme)
***********************************************************/

PSW systeme(PSW m) {

	interruptNumber(m);
	switch (m.IN) {
		case INT_INIT:
			return (systeme_init());
		case INT_SEGV:
			printf("erreur adressage \n");
			exit(-1);
			break;
		case INT_TRACE:
			systeme_trace(m);
			break;
		case INT_INST:
			printf("erreur instruction inconnue \n");
			exit(-1);
			break;
	}
	return m;
}


void interruptNumber(PSW m){
	printf("Interruption : %d\n", m.IN);
}

void systeme_trace(PSW m){
	printf("PC: %d\n", m.PC);
	int i;
	for(i=0; i < 8; i++)
		printf("DR[%d]: %d\n", i, m.DR[i]);
}